name: Test OpenWrt Integration

on:
  workflow_dispatch:
    inputs:
      test_arch:
        description: 'Test architecture'
        type: choice
        options:
          - aarch64_generic
          - x86_64
        default: 'aarch64_generic'
      test_sdk:
        description: 'Test SDK version'
        type: choice
        options:
          - 22.03.7
          - SNAPSHOT
        default: '22.03.7'

jobs:
  test:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Test OpenWrt directory structure
        run: |
          echo "Testing OpenWrt directory structure..."
          ls -la openwrt/
          ls -la openwrt/luci-app-sdwan/
          ls -la openwrt/sdwan/
          
          # Check if essential files exist
          test -f openwrt/luci-app-sdwan/Makefile
          test -f openwrt/sdwan/Makefile
          test -f openwrt/README.md
          echo "‚úÖ Directory structure is correct"

      - name: Test workflow syntax
        run: |
          echo "Testing workflow syntax..."
          # This will validate the YAML syntax
          python3 -c "import yaml; yaml.safe_load(open('.github/workflows/openwrt.yml'))"
          echo "‚úÖ OpenWrt workflow syntax is valid"

      - name: Test OpenWrt build (dry run)
        run: |
          echo "Testing OpenWrt build configuration..."
          # Check if the build configuration is valid
          if [ -d "openwrt/luci-app-sdwan" ]; then
            echo "‚úÖ LuCI app directory exists"
          else
            echo "‚ùå LuCI app directory missing"
            exit 1
          fi
          
          if [ -d "openwrt/sdwan" ]; then
            echo "‚úÖ sdwan Makefile directory exists"
          else
            echo "‚ùå sdwan Makefile directory missing"
            exit 1
          fi
          
          echo "‚úÖ OpenWrt build configuration is valid"

      - name: Test documentation
        run: |
          echo "Testing documentation..."
          # Check if README files exist and contain expected content
          if grep -q "OpenWrt" README.md; then
            echo "‚úÖ Main README contains OpenWrt reference"
          else
            echo "‚ùå Main README missing OpenWrt reference"
            exit 1
          fi
          
          if grep -q "OpenWrt" README_CN.md; then
            echo "‚úÖ Chinese README contains OpenWrt reference"
          else
            echo "‚ùå Chinese README missing OpenWrt reference"
            exit 1
          fi
          
          if [ -f "openwrt/README.md" ]; then
            echo "‚úÖ OpenWrt README exists"
          else
            echo "‚ùå OpenWrt README missing"
            exit 1
          fi
          
          echo "‚úÖ Documentation is complete"

      - name: Summary
        run: |
          echo "üéâ OpenWrt integration test completed successfully!"
          echo "üìÅ Directory structure: ‚úÖ"
          echo "‚öôÔ∏è  Workflow syntax: ‚úÖ"
          echo "üîß Build configuration: ‚úÖ"
          echo "üìö Documentation: ‚úÖ"
          echo ""
          echo "The OpenWrt plugin has been successfully integrated into the main sdwan project."
          echo "GitHub Actions will now automatically build OpenWrt packages when changes are made."
